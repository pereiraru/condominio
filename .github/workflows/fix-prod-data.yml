name: Fix Production Data

on:
  workflow_dispatch:

jobs:
  fix-data:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Find database
        id: setup
        run: |
          which sqlite3 || (apt-get update && apt-get install -y sqlite3)
          DB_PATH=$(docker volume inspect condominio_db-data --format '{{ .Mountpoint }}')/condominio.db
          echo "path=$DB_PATH" >> $GITHUB_OUTPUT
          echo "Database path: $DB_PATH"

      - name: "Diagnose: Full prod DB state"
        run: |
          DB="${{ steps.setup.outputs.path }}"

          echo "=== TABLE COUNTS ==="
          for t in Unit Owner Transaction TransactionMonth FeeHistory ExtraCharge Creditor DescriptionMapping Document BankAccount BankAccountSnapshot SupplierInvoice Budget BudgetLine; do
            COUNT=$(sqlite3 "$DB" "SELECT COUNT(*) FROM '$t';" 2>/dev/null || echo "TABLE NOT FOUND")
            echo "  $t: $COUNT"
          done

          echo ""
          echo "=== UNITS ==="
          sqlite3 "$DB" "SELECT id, code, previousBalance FROM Unit ORDER BY code;"

          echo ""
          echo "=== FEE HISTORY (all) ==="
          sqlite3 "$DB" "SELECT fh.id, u.code, fh.effectiveFrom, fh.effectiveTo, fh.amount FROM FeeHistory fh JOIN Unit u ON fh.unitId = u.id ORDER BY u.code, fh.effectiveFrom;"

          echo ""
          echo "=== TRANSACTIONS WITH CESAR ==="
          sqlite3 "$DB" "SELECT t.id, t.date, t.amount, t.description, u.code as unit FROM 'Transaction' t LEFT JOIN Unit u ON t.unitId = u.id WHERE t.description LIKE '%CESAR%' ORDER BY t.date;"

          echo ""
          echo "=== GARAGEM TRANSACTIONS ==="
          sqlite3 "$DB" "SELECT t.id, t.date, t.amount, t.description FROM 'Transaction' t JOIN Unit u ON t.unitId = u.id WHERE u.code = 'Garagem' ORDER BY t.date;"

          echo ""
          echo "=== GARAGEM ALLOCATIONS ==="
          sqlite3 "$DB" "SELECT tm.id, tm.transactionId, tm.month, tm.amount FROM TransactionMonth tm JOIN 'Transaction' t ON tm.transactionId = t.id JOIN Unit u ON t.unitId = u.id WHERE u.code = 'Garagem' ORDER BY tm.month;"

          echo ""
          echo "=== TRANSACTIONS WITHOUT ALLOCATIONS ==="
          sqlite3 "$DB" "SELECT COUNT(*) as unallocated FROM 'Transaction' t WHERE NOT EXISTS (SELECT 1 FROM TransactionMonth tm WHERE tm.transactionId = t.id);"

          echo ""
          echo "=== SAMPLE TRANSACTIONS (first 20) ==="
          sqlite3 "$DB" "SELECT t.id, t.date, t.amount, t.description, u.code FROM 'Transaction' t LEFT JOIN Unit u ON t.unitId = u.id ORDER BY t.date LIMIT 20;"

          echo ""
          echo "=== ANNUAL REPORT API TEST (check for errors) ==="
          # Try hitting the API from inside the container
          docker exec condominio-app-1 wget -q -O - "http://localhost:3000/api/reports/annual-report?year=2025" 2>&1 | head -200 || echo "API CALL FAILED"
