name: Fix Production Data

on:
  workflow_dispatch:

jobs:
  fix-data:
    runs-on: self-hosted

    steps:
      - name: Find database and install sqlite3
        id: setup
        run: |
          # Install sqlite3 on host if needed
          which sqlite3 || (apt-get update && apt-get install -y sqlite3)

          # Find the DB path on the Docker volume
          DB_PATH=$(docker volume inspect condominio_db-data --format '{{ .Mountpoint }}')/condominio.db
          echo "path=$DB_PATH" >> $GITHUB_OUTPUT
          echo "Database path: $DB_PATH"
          ls -la "$DB_PATH"

      - name: Show current state
        run: |
          DB="${{ steps.setup.outputs.path }}"

          echo "=== Cesar 2D transaction ==="
          sqlite3 "$DB" "SELECT id, amount, unitId, description FROM 'Transaction' WHERE id = 'cml89n7k40059ztjsflvsf951';"

          echo "=== Cesar 2D allocations ==="
          sqlite3 "$DB" "SELECT id, month, amount FROM TransactionMonth WHERE transactionId = 'cml89n7k40059ztjsflvsf951' ORDER BY month;"

          echo "=== Cesar 2E split (should not exist yet) ==="
          sqlite3 "$DB" "SELECT id, amount, unitId FROM 'Transaction' WHERE id = 'cesar_2e_split';" || true

          echo "=== Garagem 2nd transaction allocations ==="
          sqlite3 "$DB" "SELECT id, month, amount FROM TransactionMonth WHERE transactionId = 'cml89n7s800r7ztjs88pedru3' ORDER BY month;"

          echo "=== FeeHistory count ==="
          sqlite3 "$DB" "SELECT COUNT(*) as total FROM FeeHistory;"
          sqlite3 "$DB" "SELECT COUNT(*) as pre2024 FROM FeeHistory WHERE effectiveTo IS NOT NULL AND effectiveTo < '2024-01';"

      - name: "Fix 1: Delete pre-2024 FeeHistory"
        run: |
          DB="${{ steps.setup.outputs.path }}"
          sqlite3 "$DB" "DELETE FROM FeeHistory WHERE effectiveTo IS NOT NULL AND effectiveTo < '2024-01';"
          echo "Remaining FeeHistory:"
          sqlite3 "$DB" "SELECT COUNT(*) FROM FeeHistory;"

      - name: "Fix 2: Cesar payment split (2D=322.50, 2E=127.50)"
        run: |
          DB="${{ steps.setup.outputs.path }}"

          # Update original transaction to 322.50 on 2D
          sqlite3 "$DB" "UPDATE 'Transaction' SET amount = 322.5, unitId = 'cml24ruw6000af5lpllugo2nt' WHERE id = 'cml89n7k40059ztjsflvsf951';"
          echo "Updated transaction to 322.50 on 2D"

          # Delete old allocations
          sqlite3 "$DB" "DELETE FROM TransactionMonth WHERE transactionId = 'cml89n7k40059ztjsflvsf951';"

          # Create 2D allocations (Jan-Aug 2024)
          sqlite3 "$DB" "
          INSERT INTO TransactionMonth (id, transactionId, month, amount, createdAt) VALUES
            ('alloc_2d_jan', 'cml89n7k40059ztjsflvsf951', '2024-01', 37.5, datetime('now')),
            ('alloc_2d_feb', 'cml89n7k40059ztjsflvsf951', '2024-02', 37.5, datetime('now')),
            ('alloc_2d_mar', 'cml89n7k40059ztjsflvsf951', '2024-03', 37.5, datetime('now')),
            ('alloc_2d_apr', 'cml89n7k40059ztjsflvsf951', '2024-04', 37.5, datetime('now')),
            ('alloc_2d_may', 'cml89n7k40059ztjsflvsf951', '2024-05', 37.5, datetime('now')),
            ('alloc_2d_jun', 'cml89n7k40059ztjsflvsf951', '2024-06', 45.0, datetime('now')),
            ('alloc_2d_jul', 'cml89n7k40059ztjsflvsf951', '2024-07', 45.0, datetime('now')),
            ('alloc_2d_aug', 'cml89n7k40059ztjsflvsf951', '2024-08', 45.0, datetime('now'));
          "
          echo "Created 8 allocations for 2D (Jan-Aug 2024, total 322.50)"

          # Create 2E split transaction (127.50)
          sqlite3 "$DB" "
          INSERT OR IGNORE INTO 'Transaction' (id, date, amount, description, type, unitId, creditorId, createdAt, updatedAt)
          SELECT 'cesar_2e_split', date, 127.5, 'TR-CESAR DAVID SANTOS SA (2E)', type, 'cml24ruwa000ff5lppdhcjvaf', creditorId, datetime('now'), datetime('now')
          FROM 'Transaction' WHERE id = 'cml89n7k40059ztjsflvsf951';
          "
          echo "Created 2E split transaction (127.50)"

          # Create 2E split allocation
          sqlite3 "$DB" "
          INSERT OR IGNORE INTO TransactionMonth (id, transactionId, month, amount, createdAt) VALUES
            ('alloc_2e_split', 'cesar_2e_split', '2024-05', 127.5, datetime('now'));
          "
          echo "Created 2E split allocation"

      - name: "Fix 3: Garagem allocations (Jan-Oct 2025)"
        run: |
          DB="${{ steps.setup.outputs.path }}"

          sqlite3 "$DB" "DELETE FROM TransactionMonth WHERE transactionId = 'cml89n7s800r7ztjs88pedru3';"

          sqlite3 "$DB" "
          INSERT INTO TransactionMonth (id, transactionId, month, amount, createdAt) VALUES
            ('alloc_gar_2025_01', 'cml89n7s800r7ztjs88pedru3', '2025-01', 45.0, datetime('now')),
            ('alloc_gar_2025_02', 'cml89n7s800r7ztjs88pedru3', '2025-02', 45.0, datetime('now')),
            ('alloc_gar_2025_03', 'cml89n7s800r7ztjs88pedru3', '2025-03', 45.0, datetime('now')),
            ('alloc_gar_2025_04', 'cml89n7s800r7ztjs88pedru3', '2025-04', 45.0, datetime('now')),
            ('alloc_gar_2025_05', 'cml89n7s800r7ztjs88pedru3', '2025-05', 45.0, datetime('now')),
            ('alloc_gar_2025_06', 'cml89n7s800r7ztjs88pedru3', '2025-06', 45.0, datetime('now')),
            ('alloc_gar_2025_07', 'cml89n7s800r7ztjs88pedru3', '2025-07', 45.0, datetime('now')),
            ('alloc_gar_2025_08', 'cml89n7s800r7ztjs88pedru3', '2025-08', 45.0, datetime('now')),
            ('alloc_gar_2025_09', 'cml89n7s800r7ztjs88pedru3', '2025-09', 45.0, datetime('now')),
            ('alloc_gar_2025_10', 'cml89n7s800r7ztjs88pedru3', '2025-10', 45.0, datetime('now'));
          "
          echo "Created 10 allocations for Garagem (Jan-Oct 2025)"

      - name: Verify all fixes
        run: |
          DB="${{ steps.setup.outputs.path }}"

          echo "=== Cesar 2D transaction ==="
          sqlite3 "$DB" "SELECT id, amount, unitId FROM 'Transaction' WHERE id = 'cml89n7k40059ztjsflvsf951';"

          echo "=== Cesar 2D allocations (Jan-Aug 2024, total 322.50) ==="
          sqlite3 "$DB" "SELECT month, amount FROM TransactionMonth WHERE transactionId = 'cml89n7k40059ztjsflvsf951' ORDER BY month;"
          sqlite3 "$DB" "SELECT SUM(amount) as total FROM TransactionMonth WHERE transactionId = 'cml89n7k40059ztjsflvsf951';"

          echo "=== Cesar 2E split (127.50) ==="
          sqlite3 "$DB" "SELECT id, amount, unitId FROM 'Transaction' WHERE id = 'cesar_2e_split';"
          sqlite3 "$DB" "SELECT month, amount FROM TransactionMonth WHERE transactionId = 'cesar_2e_split';"

          echo "=== Garagem allocations (Jan-Oct 2025, total 450) ==="
          sqlite3 "$DB" "SELECT month, amount FROM TransactionMonth WHERE transactionId = 'cml89n7s800r7ztjs88pedru3' ORDER BY month;"
          sqlite3 "$DB" "SELECT SUM(amount) as total FROM TransactionMonth WHERE transactionId = 'cml89n7s800r7ztjs88pedru3';"

          echo "=== FeeHistory count ==="
          sqlite3 "$DB" "SELECT COUNT(*) FROM FeeHistory;"
          sqlite3 "$DB" "SELECT COUNT(*) as pre2024 FROM FeeHistory WHERE effectiveTo IS NOT NULL AND effectiveTo < '2024-01';"

          echo ""
          echo "=== ALL FIXES APPLIED SUCCESSFULLY ==="
