name: Fix Production Data

on:
  workflow_dispatch:

jobs:
  fix-data:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Find database
        id: setup
        run: |
          which sqlite3 || (apt-get update && apt-get install -y sqlite3)
          DB_PATH=$(docker volume inspect condominio_db-data --format '{{ .Mountpoint }}')/condominio.db
          echo "path=$DB_PATH" >> $GITHUB_OUTPUT
          echo "Database path: $DB_PATH"

      - name: Backup database
        run: |
          DB="${{ steps.setup.outputs.path }}"
          cp "$DB" "${DB}.bak.$(date +%Y%m%d%H%M%S)"
          echo "Backup created."

      - name: "Pre-fix: Count records"
        run: |
          DB="${{ steps.setup.outputs.path }}"
          echo "=== BEFORE FIX ==="
          echo "Transactions: $(sqlite3 "$DB" "SELECT COUNT(*) FROM [Transaction];")"
          echo "TransactionMonth: $(sqlite3 "$DB" "SELECT COUNT(*) FROM TransactionMonth;")"
          echo "BankAccountSnapshot: $(sqlite3 "$DB" "SELECT COUNT(*) FROM BankAccountSnapshot;")"
          echo "Garagem allocs at 37.50: $(sqlite3 "$DB" "SELECT COUNT(*) FROM TransactionMonth tm JOIN [Transaction] t ON tm.transactionId = t.id JOIN Unit u ON t.unitId = u.id WHERE u.code = 'Garagem' AND tm.amount = 37.5;")"

      - name: Apply fixes
        run: |
          DB="${{ steps.setup.outputs.path }}"
          echo "Applying fixes from SQL script..."
          sqlite3 "$DB" < scripts/fix-prod-years.sql
          echo "Fixes applied."

      - name: "Post-fix: Verify"
        run: |
          DB="${{ steps.setup.outputs.path }}"
          echo "=== AFTER FIX ==="
          echo "Transactions: $(sqlite3 "$DB" "SELECT COUNT(*) FROM [Transaction];")"
          echo "TransactionMonth: $(sqlite3 "$DB" "SELECT COUNT(*) FROM TransactionMonth;")"
          echo "BankAccountSnapshot: $(sqlite3 "$DB" "SELECT COUNT(*) FROM BankAccountSnapshot;")"

          echo ""
          echo "=== GARAGEM ALLOCATIONS ==="
          sqlite3 "$DB" "SELECT tm.month, tm.amount FROM TransactionMonth tm JOIN [Transaction] t ON tm.transactionId = t.id JOIN Unit u ON t.unitId = u.id WHERE u.code = 'Garagem' ORDER BY tm.month;"

          echo ""
          echo "=== YEAR DISTRIBUTION ==="
          sqlite3 "$DB" "SELECT strftime('%Y', datetime(date/1000, 'unixepoch')) as yr, COUNT(*) FROM [Transaction] GROUP BY yr ORDER BY yr;"

          echo ""
          echo "=== TABLE COUNTS ==="
          for t in Unit Owner Transaction TransactionMonth FeeHistory ExtraCharge Creditor DescriptionMapping Document BankAccount BankAccountSnapshot; do
            COUNT=$(sqlite3 "$DB" "SELECT COUNT(*) FROM '$t';" 2>/dev/null || echo "TABLE NOT FOUND")
            echo "  $t: $COUNT"
          done
